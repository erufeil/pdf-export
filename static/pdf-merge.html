<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unir PDFs - PDF-Export & Import</title>
    <link rel="icon" type="image/x-icon" href="/static/fav.ico">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        /* Layout de dos columnas */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        .options-panel {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 25px;
            border: 1px solid var(--color-border);
            position: sticky;
            top: 20px;
        }

        /* Zona de drop multiple */
        .drop-zone-multi {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--color-surface);
            margin-bottom: 20px;
        }

        .drop-zone-multi:hover,
        .drop-zone-multi.drag-over {
            border-color: var(--color-primary);
            background: #eff6ff;
        }

        .drop-zone-multi p {
            color: var(--color-text-light);
            margin: 8px 0 0;
            font-size: 0.9rem;
        }

        /* Lista de archivos a unir */
        .merge-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .merge-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: grab;
            transition: box-shadow 0.15s, opacity 0.15s;
            user-select: none;
        }

        .merge-item:active { cursor: grabbing; }

        .merge-item.dragging {
            opacity: 0.4;
        }

        .merge-item.drag-target {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }

        .drag-handle {
            color: var(--color-text-light);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .item-numero {
            font-weight: 700;
            color: var(--color-primary);
            min-width: 22px;
            font-size: 0.9rem;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-nombre {
            font-weight: 600;
            font-size: 0.92rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 0.8rem;
            color: var(--color-text-light);
            margin-top: 2px;
        }

        .btn-remove-item {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            flex-shrink: 0;
            transition: background 0.15s;
        }

        .btn-remove-item:hover { background: #fee2e2; }

        /* Totales */
        .totales {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 0.9rem;
            color: var(--color-primary-dark);
            margin-top: 15px;
            display: none;
        }

        .totales.visible { display: block; }

        /* Archivos del servidor */
        .server-files-section {
            margin-top: 20px;
        }

        .server-files-toggle {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 8px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--color-text-light);
            width: 100%;
            text-align: left;
            transition: all 0.15s;
        }

        .server-files-toggle:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .server-files-list {
            display: none;
            margin-top: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .server-files-list.open { display: block; }

        .server-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.88rem;
        }

        .server-file-item:last-child { border-bottom: none; }

        .server-file-item:hover { background: var(--color-background); }

        .server-file-nombre {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .server-file-meta { color: var(--color-text-light); font-size: 0.8rem; flex-shrink: 0; }

        .btn-add-server {
            background: none;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            border-radius: var(--radius-sm);
            padding: 3px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .btn-add-server:hover { background: var(--color-primary); color: white; }

        .btn-add-server:disabled { opacity: 0.4; cursor: default; }

        /* Opciones */
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .option-row:last-of-type { border-bottom: none; }

        .option-row label {
            font-size: 0.9rem;
            cursor: pointer;
            flex: 1;
        }

        /* Progreso */
        .progress-section {
            display: none;
            margin-top: 20px;
        }

        .progress-section.visible { display: block; }

        .progress-bar-wrap {
            background: var(--color-border);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-msg {
            font-size: 0.85rem;
            color: var(--color-text-light);
        }

        /* Lista vacia */
        .empty-list {
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.9rem;
            padding: 20px;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Header -->
        <header class="header">
            <h1 style="font-size: 1.8rem;">Unir PDFs</h1>
            <p class="subtitle">Combina multiples archivos PDF en uno solo</p>
        </header>

        <div class="content-grid">

            <!-- Columna principal -->
            <div>
                <!-- Drop zone para carga multiple -->
                <div class="drop-zone-multi" id="drop-zone">
                    <div style="font-size: 2.5rem;">üìé</div>
                    <strong>Arrastra PDFs aqui o haz click para seleccionar</strong>
                    <p>Pod√©s agregar m√∫ltiples archivos a la vez</p>
                    <input type="file" id="input-archivos" accept=".pdf" multiple style="display:none">
                </div>

                <!-- Lista de archivos a unir -->
                <div id="lista-merge-wrap">
                    <div class="empty-list" id="empty-msg">
                        Aun no hay archivos en la lista. Agrega al menos 2 para poder unirlos.
                    </div>
                    <ul class="merge-list" id="merge-list"></ul>
                </div>

                <!-- Totales -->
                <div class="totales" id="totales">
                    Total: <strong id="total-archivos">0</strong> archivos &nbsp;|&nbsp;
                    <strong id="total-paginas">0</strong> paginas &nbsp;|&nbsp;
                    ~<strong id="total-tamano">0 KB</strong>
                </div>

                <!-- Archivos del servidor -->
                <div class="server-files-section">
                    <button class="server-files-toggle" id="btn-toggle-server">
                        ‚ñ∂ Ver archivos cargados en el servidor
                    </button>
                    <div class="server-files-list" id="server-files-list">
                        <div id="server-files-contenido" style="padding: 10px; color: var(--color-text-light); font-size: 0.88rem;">
                            Cargando...
                        </div>
                    </div>
                </div>

                <!-- Progreso -->
                <div class="progress-section" id="progress-section">
                    <div class="progress-bar-wrap">
                        <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
                    </div>
                    <div class="progress-msg" id="progress-msg">Iniciando...</div>
                </div>

            </div>

            <!-- Panel de opciones -->
            <div class="options-panel">
                <h3 style="margin-bottom: 15px; font-size: 1rem;">Opciones</h3>

                <div class="option-row">
                    <input type="checkbox" id="opt-marcadores" checked>
                    <label for="opt-marcadores">Agregar marcadores por archivo</label>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="btn-unir" disabled style="width:100%; padding: 12px;">
                        Unir PDFs
                    </button>
                </div>

                <div id="resultado-section" style="display:none; margin-top: 15px;">
                    <a id="link-descarga" class="btn btn-success" style="width:100%; text-align:center; padding: 12px; display: block;">
                        Descargar ZIP
                    </a>
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--color-border); font-size: 0.8rem; color: var(--color-text-light);">
                    <p>El orden de la lista determina el orden en el PDF final.</p>
                    <p style="margin-top: 6px;">Arrastra los items para reordenarlos.</p>
                </div>

                <div style="margin-top: 20px;">
                    <a href="/" class="btn btn-secondary" style="width:100%; text-align:center; display:block;">
                        ‚Üê Volver al inicio
                    </a>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer class="footer">
            <p><strong>PDF-Export & Import</strong> - Herramientas de conversion PDF</p>
            <p class="footer-info"><a href="/">Volver al inicio</a></p>
            <p class="footer-info" id="app-version"></p>
        </footer>
    </div>

    <script src="/config.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
    // ============================================================
    // Estado de la pagina
    // ============================================================
    const estado = {
        items: [],          // [{file_id, nombre, paginas, tamano, origen: 'upload'|'server'}]
        subiendo: false,
        jobId: null,
        dragSrcIdx: null    // indice del item que se esta arrastrando
    };

    // ============================================================
    // Referencias al DOM
    // ============================================================
    const dropZone       = document.getElementById('drop-zone');
    const inputArchivos  = document.getElementById('input-archivos');
    const mergeList      = document.getElementById('merge-list');
    const emptyMsg       = document.getElementById('empty-msg');
    const totalesDiv     = document.getElementById('totales');
    const btnUnir        = document.getElementById('btn-unir');
    const progressSec    = document.getElementById('progress-section');
    const progressFill   = document.getElementById('progress-fill');
    const progressMsg    = document.getElementById('progress-msg');
    const resultadoSec   = document.getElementById('resultado-section');
    const linkDescarga   = document.getElementById('link-descarga');
    const API            = window.AppConfig.API_BASE_URL;

    // ============================================================
    // Drop zone: click y drag & drop
    // ============================================================
    dropZone.addEventListener('click', () => inputArchivos.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const archivos = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.pdf'));
        if (archivos.length) procesarArchivosLocales(archivos);
    });

    inputArchivos.addEventListener('change', () => {
        const archivos = Array.from(inputArchivos.files);
        if (archivos.length) procesarArchivosLocales(archivos);
        inputArchivos.value = '';
    });

    // ============================================================
    // Procesar archivos locales: verificar duplicado, subir si no existe
    // ============================================================
    async function procesarArchivosLocales(archivos) {
        for (const archivo of archivos) {
            await subirArchivoSiNecesario(archivo);
        }
    }

    async function subirArchivoSiNecesario(archivo) {
        // Verificar si ya esta en la lista
        if (estado.items.find(i => i.nombre === archivo.name && i.tamano === archivo.size)) {
            window.PDFExport.mostrarMensaje(`"${archivo.name}" ya esta en la lista`, 'warning');
            return;
        }

        // Verificar si ya esta en el servidor
        try {
            const checkResp = await fetch(`${API}/check-duplicate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: archivo.name,
                    tamano: archivo.size,
                    fecha_modificacion: new Date(archivo.lastModified).toISOString()
                })
            });
            const checkData = await checkResp.json();

            if (checkData.success && checkData.data.exists) {
                // Ya existe en servidor, agregarlo directamente
                const f = checkData.data.file;
                agregarItem({
                    file_id: f.id,
                    nombre: f.nombre_original,
                    paginas: f.num_paginas,
                    tamano: f.tamano_bytes
                });
                return;
            }
        } catch (e) {
            // Si falla la verificacion, intentar subir directamente
        }

        // Subir el archivo
        const formData = new FormData();
        formData.append('archivo', archivo);
        formData.append('nombre', archivo.name);
        formData.append('tamano', archivo.size);
        formData.append('fecha_modificacion', new Date(archivo.lastModified).toISOString());

        try {
            const resp = await fetch(`${API}/upload`, { method: 'POST', body: formData });
            const data = await resp.json();

            if (data.success) {
                agregarItem({
                    file_id: data.data.id,
                    nombre: data.data.nombre_original,
                    paginas: data.data.num_paginas,
                    tamano: data.data.tamano_bytes
                });
                if (data.data.ya_existia) {
                    window.PDFExport.mostrarMensaje(`"${archivo.name}" ya estaba en el servidor`, 'info');
                }
            } else {
                window.PDFExport.mostrarMensaje(`Error subiendo "${archivo.name}": ${data.error.message}`, 'error');
            }
        } catch (e) {
            window.PDFExport.mostrarMensaje(`Error de red subiendo "${archivo.name}"`, 'error');
        }
    }

    // ============================================================
    // Agregar un item a la lista
    // ============================================================
    function agregarItem(item) {
        // Verificar que no este ya (por file_id)
        if (estado.items.find(i => i.file_id === item.file_id)) {
            window.PDFExport.mostrarMensaje(`"${item.nombre}" ya esta en la lista`, 'warning');
            return;
        }
        estado.items.push(item);
        renderizarLista();
    }

    // ============================================================
    // Renderizar la lista de merge
    // ============================================================
    function renderizarLista() {
        mergeList.innerHTML = '';

        if (estado.items.length === 0) {
            emptyMsg.style.display = 'block';
            totalesDiv.classList.remove('visible');
            btnUnir.disabled = true;
            return;
        }

        emptyMsg.style.display = 'none';
        totalesDiv.classList.add('visible');
        btnUnir.disabled = estado.items.length < 2;

        estado.items.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = 'merge-item';
            li.draggable = true;
            li.dataset.idx = idx;

            li.innerHTML = `
                <span class="drag-handle">‚†ø</span>
                <span class="item-numero">${idx + 1}.</span>
                <div class="item-info">
                    <div class="item-nombre" title="${item.nombre}">${item.nombre}</div>
                    <div class="item-meta">${item.paginas} pags. ¬∑ ${window.PDFExport.formatearTamano(item.tamano)}</div>
                </div>
                <button class="btn-remove-item" title="Quitar de la lista">‚úï</button>
            `;

            // Boton quitar
            li.querySelector('.btn-remove-item').addEventListener('click', () => {
                estado.items.splice(idx, 1);
                renderizarLista();
            });

            // Drag & drop para reordenar
            li.addEventListener('dragstart', (e) => {
                estado.dragSrcIdx = idx;
                li.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            li.addEventListener('dragend', () => {
                li.classList.remove('dragging');
                document.querySelectorAll('.merge-item').forEach(el => el.classList.remove('drag-target'));
            });

            li.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                document.querySelectorAll('.merge-item').forEach(el => el.classList.remove('drag-target'));
                li.classList.add('drag-target');
            });

            li.addEventListener('drop', (e) => {
                e.preventDefault();
                const destIdx = parseInt(li.dataset.idx);
                if (estado.dragSrcIdx === null || estado.dragSrcIdx === destIdx) return;

                // Mover el item en el array
                const [movido] = estado.items.splice(estado.dragSrcIdx, 1);
                estado.items.splice(destIdx, 0, movido);
                estado.dragSrcIdx = null;
                renderizarLista();
            });

            mergeList.appendChild(li);
        });

        // Calcular totales
        const totalPaginas = estado.items.reduce((s, i) => s + (i.paginas || 0), 0);
        const totalTamano  = estado.items.reduce((s, i) => s + (i.tamano || 0), 0);
        document.getElementById('total-archivos').textContent = estado.items.length;
        document.getElementById('total-paginas').textContent = totalPaginas;
        document.getElementById('total-tamano').textContent = window.PDFExport.formatearTamano(totalTamano);
    }

    // ============================================================
    // Archivos del servidor
    // ============================================================
    const btnToggleServer = document.getElementById('btn-toggle-server');
    const serverFilesList = document.getElementById('server-files-list');

    btnToggleServer.addEventListener('click', () => {
        const abierto = serverFilesList.classList.toggle('open');
        btnToggleServer.textContent = (abierto ? '‚ñº' : '‚ñ∂') + ' Ver archivos cargados en el servidor';
        if (abierto) cargarArchivosServidor();
    });

    async function cargarArchivosServidor() {
        const cont = document.getElementById('server-files-contenido');
        cont.innerHTML = 'Cargando...';

        try {
            const resp = await fetch(`${API}/files`);
            const data = await resp.json();

            if (!data.success || data.data.length === 0) {
                cont.innerHTML = '<div style="padding:10px; color: var(--color-text-light);">No hay archivos disponibles en el servidor.</div>';
                return;
            }

            cont.innerHTML = data.data.map(f => `
                <div class="server-file-item">
                    <span class="server-file-nombre" title="${f.nombre_original}">${f.nombre_original}</span>
                    <span class="server-file-meta">${f.num_paginas} pags.</span>
                    <button class="btn-add-server" data-id="${f.id}" data-nombre="${f.nombre_original}"
                            data-paginas="${f.num_paginas}" data-tamano="${f.tamano_bytes}">
                        + Agregar
                    </button>
                </div>
            `).join('');

            cont.querySelectorAll('.btn-add-server').forEach(btn => {
                btn.addEventListener('click', () => {
                    agregarItem({
                        file_id: btn.dataset.id,
                        nombre: btn.dataset.nombre,
                        paginas: parseInt(btn.dataset.paginas),
                        tamano: parseInt(btn.dataset.tamano)
                    });
                    btn.disabled = true;
                    btn.textContent = '‚úì';
                });
            });

        } catch (e) {
            cont.innerHTML = '<div style="padding:10px; color: var(--color-danger);">Error cargando archivos del servidor.</div>';
        }
    }

    // ============================================================
    // Ejecutar la union
    // ============================================================
    btnUnir.addEventListener('click', async () => {
        if (estado.items.length < 2) return;

        btnUnir.disabled = true;
        resultadoSec.style.display = 'none';
        progressSec.classList.add('visible');
        progressFill.style.width = '0%';
        progressMsg.textContent = 'Iniciando...';

        const payload = {
            archivos: estado.items.map((item, idx) => ({
                file_id: item.file_id,
                orden: idx + 1
            })),
            opciones: {
                agregar_marcadores: document.getElementById('opt-marcadores').checked
            }
        };

        try {
            const resp = await fetch(`${API}/convert/merge`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await resp.json();

            if (!data.success) {
                window.PDFExport.mostrarMensaje(`Error: ${data.error.message}`, 'error');
                btnUnir.disabled = false;
                progressSec.classList.remove('visible');
                return;
            }

            // Monitorear progreso via SSE
            monitorearProgreso(data.data.job_id);

        } catch (e) {
            window.PDFExport.mostrarMensaje('Error de red al iniciar la union', 'error');
            btnUnir.disabled = false;
            progressSec.classList.remove('visible');
        }
    });

    // ============================================================
    // Monitorear progreso via SSE
    // ============================================================
    function monitorearProgreso(jobId) {
        estado.jobId = jobId;
        const sse = new EventSource(`${API}/jobs/${jobId}/progress`);

        sse.onmessage = (e) => {
            try {
                const datos = JSON.parse(e.data);

                progressFill.style.width = datos.progreso + '%';
                progressMsg.textContent = datos.mensaje || `${datos.progreso}%`;

                if (datos.estado === 'completado') {
                    sse.close();
                    progressFill.style.width = '100%';
                    progressMsg.textContent = 'Completado. Descargando...';

                    const urlDescarga = `${API}/download/${jobId}`;
                    linkDescarga.href = urlDescarga;
                    resultadoSec.style.display = 'block';

                    // Descarga automatica
                    const a = document.createElement('a');
                    a.href = urlDescarga;
                    a.download = '';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    btnUnir.disabled = false;

                } else if (datos.estado === 'error') {
                    sse.close();
                    progressMsg.textContent = 'Error: ' + (datos.mensaje || 'Fallo desconocido');
                    progressFill.style.background = 'var(--color-danger)';
                    window.PDFExport.mostrarMensaje(datos.mensaje || 'Error en la union', 'error');
                    btnUnir.disabled = false;
                }

            } catch (err) {
                // ignorar errores de parseo
            }
        };

        sse.onerror = () => {
            sse.close();
            progressMsg.textContent = 'Error de conexion. Verificando estado...';
            verificarEstadoFinal(jobId);
        };
    }

    // Fallback por si se corta el SSE
    async function verificarEstadoFinal(jobId) {
        try {
            const resp = await fetch(`${API}/jobs/${jobId}`);
            const data = await resp.json();
            if (data.success && data.data.estado === 'completado') {
                progressFill.style.width = '100%';
                progressMsg.textContent = 'Completado.';
                const urlDescarga = `${API}/download/${jobId}`;
                linkDescarga.href = urlDescarga;
                resultadoSec.style.display = 'block';
            }
        } catch (e) { /* silencioso */ }
        btnUnir.disabled = false;
    }

    // ============================================================
    // Init
    // ============================================================
    renderizarLista();
    </script>
</body>
</html>
