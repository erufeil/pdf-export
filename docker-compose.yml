# PDFexport - Docker Compose
# Las variables se pueden configurar desde Portainer Stack o archivo .env
services:
  pdfexport:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdfexport
    restart: unless-stopped
    networks: 
      ${NETWORK}:
        ipv4_address: ${NETWORK_IP}

    # Variables de entorno (configurables desde Portainer)
    environment:
      # Configuracion del servidor Flask
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-5000}
      - DEBUG=${DEBUG:-False}

      # Retencion de archivos (horas)
      - FILE_RETENTION_HOURS=${FILE_RETENTION_HOURS:-4}

      # Configuracion del frontend (inyectadas en config.js)
      # La URL de la API se detecta automaticamente desde window.location.origin
      - TIMEOUT=${TIMEOUT:-30000}
      - RETRY_ATTEMPTS=${RETRY_ATTEMPTS:-3}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-1073741824}
      # 1Gb = 1024 * 1024 * 1024 bytes

    # Puertos expuestos
    ports:
      - "${PORT:-5000}:${PORT:-5000}"

    # Volumenes para persistencia
    volumes:
      # Base de datos SQLite
      - pdfexport_data:/app/data
      # Archivos subidos (opcional, se limpian segun FILE_RETENTION_HOURS)
      - pdfexport_uploads:/app/uploads
      # Archivos de salida (opcional)
      - pdfexport_outputs:/app/outputs

    # Limites de recursos
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

    # Healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-5000}/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Volumenes nombrados
volumes:
  pdfexport_data:
    name: pdfexport_data
  pdfexport_uploads:
    name: pdfexport_uploads
  pdfexport_outputs:
    name: pdfexport_outputs
#Netoworks Pre-definidas
networks:
  ${NETWORK}:
    external: true